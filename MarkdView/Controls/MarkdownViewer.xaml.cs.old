using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Threading;
using Markdig;
using Markdig.Renderers;
using Markdig.Wpf;
using MarkdView.Renderers.Blocks;

namespace MarkdView.Controls;

/// <summary>
/// MarkdView - 现代化 WPF Markdown 渲染控件
/// 特性：流式渲染、语法高亮、主题支持
/// </summary>
public partial class MarkdownViewer : UserControl
{
    #region 依赖属性

    /// <summary>
    /// Markdown 文本内容
    /// </summary>
    public static readonly DependencyProperty MarkdownProperty =
        DependencyProperty.Register(
            nameof(Markdown),
            typeof(string),
            typeof(MarkdownViewer),
            new PropertyMetadata(string.Empty, OnMarkdownChanged));

    /// <summary>
    /// 是否启用流式渲染（默认 true）
    /// </summary>
    public static readonly DependencyProperty EnableStreamingProperty =
        DependencyProperty.Register(
            nameof(EnableStreaming),
            typeof(bool),
            typeof(MarkdownViewer),
            new PropertyMetadata(true));

    /// <summary>
    /// 流式渲染防抖间隔（毫秒，默认 50）
    /// </summary>
    public static readonly DependencyProperty StreamingThrottleProperty =
        DependencyProperty.Register(
            nameof(StreamingThrottle),
            typeof(int),
            typeof(MarkdownViewer),
            new PropertyMetadata(50, OnStreamingThrottleChanged));

    /// <summary>
    /// 是否启用代码语法高亮（默认 true）
    /// </summary>
    public static readonly DependencyProperty EnableSyntaxHighlightingProperty =
        DependencyProperty.Register(
            nameof(EnableSyntaxHighlighting),
            typeof(bool),
            typeof(MarkdownViewer),
            new PropertyMetadata(true));

    #endregion

    #region 公共属性

    public string Markdown
    {
        get => (string)GetValue(MarkdownProperty);
        set => SetValue(MarkdownProperty, value);
    }

    public bool EnableStreaming
    {
        get => (bool)GetValue(EnableStreamingProperty);
        set => SetValue(EnableStreamingProperty, value);
    }

    public int StreamingThrottle
    {
        get => (int)GetValue(StreamingThrottleProperty);
        set => SetValue(StreamingThrottleProperty, value);
    }

    public bool EnableSyntaxHighlighting
    {
        get => (bool)GetValue(EnableSyntaxHighlightingProperty);
        set => SetValue(EnableSyntaxHighlightingProperty, value);
    }

    #endregion

    #region 私有字段

    private readonly MarkdownPipeline _pipeline;
    private readonly DispatcherTimer _updateTimer;
    private string _lastRenderedText = string.Empty;
    private string _pendingText = string.Empty;
    private bool _hasPendingUpdate;

    #endregion

    #region 构造函数

    public MarkdownViewer()
    {
        InitializeComponent();

        // 配置 Markdig 管道 - 启用所有扩展
        _pipeline = new MarkdownPipelineBuilder()
            .UseSupportedExtensions()
            .Build();

        // 初始化防抖计时器
        _updateTimer = new DispatcherTimer
        {
            Interval = TimeSpan.FromMilliseconds(StreamingThrottle)
        };
        _updateTimer.Tick += OnUpdateTimerTick;

        // 委托滚轮事件给父 ScrollViewer
        MarkdownDocument.PreviewMouseWheel += OnPreviewMouseWheel;
    }

    /// <summary>
    /// 链接点击事件
    /// </summary>
    public event EventHandler<LinkClickedEventArgs>? LinkClicked;

    /// <summary>
    /// 触发链接点击事件
    /// </summary>
    internal void OnLinkClicked(LinkClickedEventArgs args)
    {
        LinkClicked?.Invoke(this, args);
    }

    /// <summary>
    /// 链接点击事件参数
    /// </summary>
    public class LinkClickedEventArgs : EventArgs
    {
        public string Href { get; init; } = string.Empty;
        public string? Text { get; init; }
    }

    #endregion

    #region 属性变更回调

    private static void OnMarkdownChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
    {
        if (d is MarkdownViewer viewer)
        {
            var markdown = e.NewValue as string ?? string.Empty;

            if (viewer.EnableStreaming)
            {
                viewer.QueueUpdate(markdown);
            }
            else
            {
                viewer.UpdateMarkdown(markdown);
            }
        }
    }

    private static void OnStreamingThrottleChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
    {
        if (d is MarkdownViewer viewer && e.NewValue is int throttle)
        {
            viewer._updateTimer.Interval = TimeSpan.FromMilliseconds(throttle);
        }
    }

    #endregion

    #region 流式渲染逻辑

    /// <summary>
    /// 队列更新 - 用于流式渲染
    /// </summary>
    private void QueueUpdate(string markdown)
    {
        _pendingText = markdown;
        _hasPendingUpdate = true;

        if (!_updateTimer.IsEnabled)
        {
            _updateTimer.Start();
        }
    }

    /// <summary>
    /// 定时器触发 - 批量处理待更新的内容
    /// </summary>
    private void OnUpdateTimerTick(object? sender, EventArgs e)
    {
        if (!_hasPendingUpdate)
        {
            _updateTimer.Stop();
            return;
        }

        _hasPendingUpdate = false;
        UpdateMarkdown(_pendingText);
    }

    #endregion

    #region Markdown 渲染

    /// <summary>
    /// 实际渲染逻辑
    /// </summary>
    private void UpdateMarkdown(string markdown)
    {
        // 空内容处理
        if (string.IsNullOrWhiteSpace(markdown))
        {
            MarkdownDocument.Document = new FlowDocument();
            _lastRenderedText = string.Empty;
            return;
        }

        // 缓存机制 - 避免重复渲染
        if (markdown == _lastRenderedText)
            return;

        try
        {
            // 创建自定义渲染器
            var renderer = CreateRenderer();

            // 转换 Markdown 到 FlowDocument
            var document = Markdig.Wpf.Markdown.ToFlowDocument(markdown, _pipeline, renderer);

            // 应用自定义样式
            ApplyCustomStyles(document);

            MarkdownDocument.Document = document;
            _lastRenderedText = markdown;
        }
        catch (Exception ex)
        {
            // 降级处理
            var fallbackDocument = new FlowDocument();
            var errorInfo = new Paragraph(new Run($"[Markdown 渲染错误: {ex.Message}]"))
            {
                FontSize = 12,
                Margin = new Thickness(0, 0, 0, 8),
                Foreground = Brushes.Red
            };

            var paragraph = new Paragraph(new Run(markdown))
            {
                Margin = new Thickness(0),
                Foreground = Brushes.Gray
            };

            fallbackDocument.Blocks.Add(errorInfo);
            fallbackDocument.Blocks.Add(paragraph);
            MarkdownDocument.Document = fallbackDocument;
        }
    }

    /// <summary>
    /// 创建自定义渲染器
    /// </summary>
    private WpfRenderer CreateRenderer()
    {
        var renderer = new WpfRenderer();

        // 如果启用语法高亮，替换默认的 CodeBlockRenderer
        if (EnableSyntaxHighlighting)
        {
            renderer.ObjectRenderers.RemoveAll(r => r is Markdig.Renderers.Wpf.CodeBlockRenderer);
            renderer.ObjectRenderers.Add(new CodeBlockRenderer());
        }

        // 替换默认的行内代码渲染器
        renderer.ObjectRenderers.RemoveAll(r => r is Markdig.Renderers.Wpf.Inlines.CodeInlineRenderer);
        renderer.ObjectRenderers.Add(new MarkdView.Renderers.Inlines.CodeInlineRenderer());

        // 添加链接点击处理
        renderer.ObjectRenderers.Add(new MarkdView.Renderers.Inlines.LinkInlineRenderer(this));

        return renderer;
    }

    /// <summary>
    /// 应用自定义样式
    /// </summary>
    private void ApplyCustomStyles(FlowDocument document)
    {
        // 设置文档基础样式 - 从主题资源读取
        document.FontFamily = GetFontFamily();
        document.FontSize = GetFontSize();
        document.LineHeight = GetLineHeight();
        document.PagePadding = new Thickness(0);

        // 动态绑定主题颜色（如果可用）
        TrySetResourceReference(document, FlowDocument.ForegroundProperty, "Markdown.Foreground");
        TrySetResourceReference(document, FlowDocument.BackgroundProperty, "Markdown.Background");

        // 高质量文本渲染
        TextOptions.SetTextFormattingMode(document, TextFormattingMode.Display);
        TextOptions.SetTextRenderingMode(document, TextRenderingMode.ClearType);

        // 遍历应用块样式
        foreach (var block in document.Blocks)
        {
            ApplyBlockStyles(block);
        }
    }

    /// <summary>
    /// 获取字体族
    /// </summary>
    private FontFamily GetFontFamily()
    {
        if (Application.Current?.Resources.Contains("Markdown.FontFamily") == true)
        {
            return (FontFamily)Application.Current.Resources["Markdown.FontFamily"];
        }
        return new FontFamily("PingFang SC, Microsoft YaHei, sans-serif");
    }

    /// <summary>
    /// 获取字体大小
    /// </summary>
    private double GetFontSize()
    {
        if (Application.Current?.Resources.Contains("Markdown.FontSize") == true)
        {
            return (double)Application.Current.Resources["Markdown.FontSize"];
        }
        return 14;
    }

    /// <summary>
    /// 获取行高
    /// </summary>
    private double GetLineHeight()
    {
        if (Application.Current?.Resources.Contains("Markdown.LineHeight") == true)
        {
            var lineHeight = (double)Application.Current.Resources["Markdown.LineHeight"];
            // Markdown.LineHeight 是相对值（如 1.6），需要转换为绝对值
            return lineHeight * GetFontSize();
        }
        return 22.4; // 14 * 1.6
    }

    /// <summary>
    /// 应用块元素样式（递归）
    /// </summary>
    private void ApplyBlockStyles(Block block)
    {
        switch (block)
        {
            case Paragraph paragraph:
                paragraph.Margin = new Thickness(0, 4, 0, 8);
                paragraph.TextAlignment = TextAlignment.Left;

                // 标题样式
                if (paragraph.Tag is int headingLevel)
                {
                    ApplyHeadingStyles(paragraph, headingLevel);
                }
                break;

            case Section section:
                // 引用块
                if (section.Tag?.ToString() == "BlockQuote")
                {
                    section.Padding = new Thickness(16, 12, 16, 12);
                    section.Margin = new Thickness(0, 12, 0, 12);
                    TrySetResourceReference(section, Section.BackgroundProperty, "Markdown.Quote.Background");
                    TrySetResourceReference(section, Section.BorderBrushProperty, "Markdown.Quote.Border");
                    section.BorderThickness = new Thickness(4, 0, 0, 0);
                }

                // 递归处理子块
                foreach (var childBlock in section.Blocks)
                {
                    ApplyBlockStyles(childBlock);
                }
                break;

            case List list:
                list.Margin = new Thickness(20, 8, 0, 8);
                list.Padding = new Thickness(0);

                // 递归处理列表项
                foreach (ListItem item in list.ListItems)
                {
                    foreach (var childBlock in item.Blocks)
                    {
                        ApplyBlockStyles(childBlock);
                    }
                }
                break;

            case Table table:
                ApplyTableStyles(table);
                break;

            case BlockUIContainer container:
                container.Margin = new Thickness(0, 12, 0, 12);
                break;
        }
    }

    /// <summary>
    /// 应用标题样式 - 根据参考标准 (H1=28, H2=24, H3=20, H4=17, H5-H6=15)
    /// </summary>
    private void ApplyHeadingStyles(Paragraph paragraph, int level)
    {
        switch (level)
        {
            case 1:
                paragraph.FontSize = GetHeadingFontSize(1);
                paragraph.FontWeight = FontWeights.Bold;
                paragraph.Margin = new Thickness(0, 16, 0, 12);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H1.Foreground");
                TrySetResourceReference(paragraph, Paragraph.BorderBrushProperty, "Markdown.Heading.H1.Border");
                paragraph.BorderThickness = new Thickness(0, 0, 0, 1);
                break;

            case 2:
                paragraph.FontSize = GetHeadingFontSize(2);
                paragraph.FontWeight = FontWeights.SemiBold;
                paragraph.Margin = new Thickness(0, 14, 0, 10);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H2.Foreground");
                TrySetResourceReference(paragraph, Paragraph.BorderBrushProperty, "Markdown.Heading.H2.Border");
                paragraph.BorderThickness = new Thickness(0, 0, 0, 1);
                break;

            case 3:
                paragraph.FontSize = GetHeadingFontSize(3);
                paragraph.FontWeight = FontWeights.SemiBold;
                paragraph.Margin = new Thickness(0, 12, 0, 8);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H3.Foreground");
                break;

            case 4:
                paragraph.FontSize = GetHeadingFontSize(4);
                paragraph.FontWeight = FontWeights.Medium;
                paragraph.Margin = new Thickness(0, 10, 0, 6);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H4.Foreground");
                break;

            case 5:
                paragraph.FontSize = GetHeadingFontSize(5);
                paragraph.FontWeight = FontWeights.Medium;
                paragraph.Margin = new Thickness(0, 8, 0, 4);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H5.Foreground");
                break;

            case 6:
                paragraph.FontSize = GetHeadingFontSize(6);
                paragraph.FontWeight = FontWeights.Medium;
                paragraph.Margin = new Thickness(0, 8, 0, 4);
                TrySetResourceReference(paragraph, Paragraph.ForegroundProperty, "Markdown.Heading.H6.Foreground");
                break;
        }
    }

    /// <summary>
    /// 获取标题字体大小
    /// </summary>
    private double GetHeadingFontSize(int level)
    {
        var resourceKey = $"Markdown.Heading.H{level}.FontSize";
        if (Application.Current?.Resources.Contains(resourceKey) == true)
        {
            return (double)Application.Current.Resources[resourceKey];
        }

        // 默认值 - 匹配参考标准
        return level switch
        {
            1 => 28,
            2 => 24,
            3 => 20,
            4 => 17,
            5 => 15,
            6 => 15,
            _ => 14
        };
    }

    /// <summary>
    /// 应用表格样式
    /// </summary>
    private void ApplyTableStyles(Table table)
    {
        table.CellSpacing = 0;
        table.Margin = new Thickness(0, 12, 0, 12);
        TrySetResourceReference(table, Table.BorderBrushProperty, "Markdown.Table.Border");
        table.BorderThickness = new Thickness(1);

        foreach (var rowGroup in table.RowGroups)
        {
            foreach (var row in rowGroup.Rows)
            {
                foreach (var cell in row.Cells)
                {
                    cell.Padding = new Thickness(8, 6, 8, 6);
                    TrySetResourceReference(cell, TableCell.BorderBrushProperty, "Markdown.Table.Border");
                    cell.BorderThickness = new Thickness(1);

                    // 表头样式
                    if (rowGroup.Rows.IndexOf(row) == 0)
                    {
                        TrySetResourceReference(cell, TableCell.BackgroundProperty, "Markdown.Table.HeaderBackground");
                        cell.FontWeight = FontWeights.SemiBold;
                    }

                    // 递归处理单元格内容
                    foreach (var cellBlock in cell.Blocks)
                    {
                        ApplyBlockStyles(cellBlock);
                    }
                }
            }
        }
    }

    /// <summary>
    /// 尝试设置资源引用（如果资源不存在则跳过）
    /// </summary>
    private void TrySetResourceReference(FrameworkContentElement element, DependencyProperty dp, string resourceKey)
    {
        try
        {
            if (Application.Current?.Resources.Contains(resourceKey) == true)
            {
                element.SetResourceReference(dp, resourceKey);
            }
        }
        catch
        {
            // 资源不存在，使用默认值
        }
    }

    #endregion

    #region 滚轮事件处理

    /// <summary>
    /// 滚轮事件委托给父 ScrollViewer
    /// </summary>
    private void OnPreviewMouseWheel(object sender, MouseWheelEventArgs e)
    {
        if (e.Handled) return;

        var parent = FindParentScrollViewer();
        if (parent != null)
        {
            var scrollDelta = e.Delta * 0.5;
            var newOffset = parent.VerticalOffset - scrollDelta;
            newOffset = Math.Max(0, Math.Min(newOffset, parent.ScrollableHeight));
            parent.ScrollToVerticalOffset(newOffset);
            e.Handled = true;
        }
    }

    /// <summary>
    /// 查找父级 ScrollViewer
    /// </summary>
    private ScrollViewer? FindParentScrollViewer()
    {
        DependencyObject? parent = this;
        while (parent != null)
        {
            parent = VisualTreeHelper.GetParent(parent);
            if (parent is ScrollViewer scrollViewer)
                return scrollViewer;
        }
        return null;
    }

    #endregion

    #region 公共方法

    /// <summary>
    /// 清空内容
    /// </summary>
    public void Clear()
    {
        Markdown = string.Empty;
    }

    /// <summary>
    /// 追加 Markdown 内容（流式场景）
    /// </summary>
    public void AppendMarkdown(string markdown)
    {
        Markdown += markdown;
    }

    #endregion
}
